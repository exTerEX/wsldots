#!/usr/bin/env bash

# Let script exit when a command fail
set -o errexit

# Let script exit if an unset variable is used
set -o nounset

# Update packages
sudo apt -y update
sudo apt -y full-upgrade

# Running under WSL (Windows Subsystem for Linux)
if cat /proc/version | grep microsoft; then
  echo "Running in WSL mode..."
  WSL=true
else
  echo "Running in normal mode..."
  WSL=false
fi

# Get Windows username
if $WSL; then
  echo "Finding Windows username..."
  WINDOWS_USER=$(/mnt/c/Windows/System32/cmd.exe /c 'echo %USERNAME%' | sed -e 's/\r//g')
fi

if [[ -e ~/.bashrc && ! -e ~/.oh-my-bash ]]; then
  echo "Remove .bashrc..."
  sudo rm -rf ~/.bashrc
else
  echo "Not removing .bashrc..."
fi

# Define USERPATH running WSL mode
if $WSL; then
  echo "Windows 10 %USERPROFILE%..."
  USERPATH=/mnt/c/Users/$WINDOWS_USER
fi

# Use Windows .gitconfig if possible else use repo version
if $WSL; then
  if [[ -e $USERPATH/.gitconfig ]]; then
    echo "Using Windows .gitconfig file..."
    sudo ln -sf $USERPATH/.gitconfig ~/
  else
    echo "Using repo .gitconfig file..."
    sudo ln -sf ~/.dotfiles/.gitconfig ~/
  fi
else
  if [[ ! -e ~/.gitconfig ]]; then
    echo "Using repo .gitconfig file..."
    sudo ln -sf ~/.dotfiles/.gitconfig ~/
  fi
fi

# Use Windows .ssh key and known_hosts if possible
if $WSL; then
  if [[ ! -e ~/.ssh ]]; then
    echo "Copying .ssh files to .ssh/..."
    cp -r $USERPATH/.ssh ~/
  fi

  if [[ ! -h ~/.ssh/known_hosts ]]; then
    echo "Creating symlink to known_hosts..."
    sudo ln -sf $USERPATH/.ssh/known_hosts ~/.ssh/known_hosts
  fi

  # TODO: Make so it automatically find name of file
  #       (probably using search for *.pub file)
  # sudo chmod 600 ~/.ssh/id_rsa
  # sudo chmod 600 ~/.ssh/id_rsa.pub
  # TODO: Potential to performe chmod in one line?
  # sudo ssh-add ~/.ssh/id_rsa
fi

# Remove bloat
if [[ -e /etc/apt/apt.conf.d/20snapd.conf ]]; then
  echo "Removing /etc/apt/apt.conf.d/20snapd.conf..."
  sudo rm -f /etc/apt/apt.conf.d/20snapd.conf
fi

sudo apt -y autoremove snapd

# Clean
sudo apt -y autoremove
if [[ -d /var/lib/apt/lists ]]; then
  echo "Removing package list..."
  sudo rm -rf /var/lib/apt/lists/*
fi
sudo apt clean -y

# Install oh-my-bash
if [[ ! -e ~/.oh-my-bash ]]; then
  sh -c "$(curl -fsSL https://raw.github.com/ohmybash/oh-my-bash/master/tools/install.sh)"
fi
