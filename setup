#!/usr/bin/env bash

# Let script exit when a command fail
set -o errexit

# Let script exit if an unset variable is used
set -o nounset

# Update packages
sudo apt -y update
sudo apt -y full-upgrade

# Running under WSL (Windows Subsystem for Linux)
if cat /proc/version | grep microsoft; then
  echo "Running in WSL mode..."
  WSL=true
else
  echo "Running in normal mode..."
  WSL=false
fi

# Get Windows username
if $WSL; then
  echo "Finding Windows username..."
  WINDOWS_USER=$(/mnt/c/Windows/System32/cmd.exe /c 'echo %USERNAME%' | sed -e 's/\r//g')
fi

if [[ -e ~/.bashrc ]]; then
  echo "Remove .bashrc..."
  sudo rm -rf ~/.bashrc
fi

# Install "Oh My Bash" & clean
sh -c "$(curl -fsSL https://raw.github.com/ohmybash/oh-my-bash/master/tools/install.sh)"

# Define USERPATH running WSL mode
if $WSL; then
  echo "Windows 10 %USERPROFILE%..."
  USERPATH=/mnt/c/Users/$WINDOWS_USER
fi

# Use Windows .gitconfig if possible else use repo's version.
if $WSL; then
  if [[ -e "$USERPATH/.gitconfig" && ! -e ~/.gitconfig ]]; then
    echo "Using Windows' .gitconfig file..."
    ln -sf $USERPATH/.gitconfig ~/
  elif [[ ! -e ~/.gitconfig ]]; then
    echo "Using repo's .gitignore file..."
    ln -sf .gitconfig ~/
  fi
else
  if [[ ! -e ~/.gitconfig ]]; then
    echo "Using repo's .gitignore file..."
    ln -sf .gitconfig ~/
  fi
fi

if $WSL; then
  if [[ ! -d ~/.ssh ]]; then
    echo "Creating folder ~/.ssh/..."
    mkdir ~/.ssh
  fi

  if [[ ! -e ~/.ssh/id_rsa ]]; then
    echo "Copying .ssh files to .ssh/..."
    cp $USERPATH/.ssh/id_rsa ~/.ssh/
  fi

  if [[ ! -e ~/.ssh/id_rsa.pub ]]; then
    echo "Copying .ssh files to .ssh/..."
    cp $USERPATH/.ssh/id_rsa.pub ~/.ssh/
  fi

  if [[ ! -e ~/.ssh/known_hosts ]]; then
    echo "Creating symlink to known_hosts..."
    ln -sf $USERPATH/.ssh/known_hosts ~/.ssh/known_hosts
  fi
fi

# Remove bloat
if [[ -e /etc/apt/apt.conf.d/20snapd.conf ]]; then
  echo "Removing /etc/apt/apt.conf.d/20snapd.conf..."
  sudo rm -f /etc/apt/apt.conf.d/20snapd.conf
fi

sudo apt -y autoremove snapd

# Clean
sudo apt -y autoremove
if [[ -d /var/lib/apt/lists ]]; then
  echo "Removing package list..."
  rm -rf /var/lib/apt/lists/*
fi
sudo apt clean -y